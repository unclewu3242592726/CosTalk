<!DOCTYPE html>
<html>
<head>
    <title>CosTalk WebSocket Test</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #messages { 
            border: 1px solid #ccc; 
            height: 400px; 
            overflow-y: scroll; 
            padding: 10px; 
            margin: 10px 0; 
            background: #f9f9f9;
        }
        .message { 
            margin: 5px 0; 
            padding: 5px; 
            border-radius: 3px;
        }
        .config { background: #e7f3ff; }
        .text { background: #fff2e7; }
        .response { background: #e7ffe7; }
        .error { background: #ffe7e7; color: red; }
        .asr { background: #f0e7ff; }
        .tts { background: #e7fff0; }
        button { margin: 5px; padding: 10px; }
        input, textarea { margin: 5px; padding: 5px; width: 300px; }
    </style>
</head>
<body>
    <h1>CosTalk WebSocket 测试</h1>
    
    <div>
        <button onclick="connect()">连接</button>
        <button onclick="disconnect()">断开</button>
        <span id="status">未连接</span>
    </div>

    <div>
        <h3>发送配置</h3>
        <input type="text" id="llmProvider" placeholder="LLM Provider (默认: qiniu)" />
        <input type="text" id="asrProvider" placeholder="ASR Provider (默认: qiniu)" />
        <input type="text" id="ttsProvider" placeholder="TTS Provider (默认: qiniu)" />
        <button onclick="sendConfig()">发送配置</button>
    </div>

    <div>
        <h3>发送文本</h3>
        <textarea id="textInput" placeholder="输入文本消息"></textarea><br>
        <button onclick="sendText()">发送文本</button>
    </div>

    <div>
        <h3>发送音频（模拟）</h3>
        <button onclick="sendAudio()">发送测试音频</button>
    </div>

    <div id="messages"></div>

    <script>
        let ws = null;
        let messageSeq = 0;

        function connect() {
            if (ws) {
                ws.close();
            }
            
            ws = new WebSocket('ws://localhost:8888/v1/chat/stream');
            
            ws.onopen = function(event) {
                updateStatus('已连接');
                addMessage('info', 'WebSocket 连接已建立');
            };
            
            ws.onmessage = function(event) {
                try {
                    const message = JSON.parse(event.data);
                    addMessage(message.type, JSON.stringify(message, null, 2));
                } catch (e) {
                    addMessage('error', '解析消息失败: ' + event.data);
                }
            };
            
            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
                addMessage('error', 'WebSocket 错误详情: ' + JSON.stringify(error));
            };
            
            ws.onclose = function(event) {
                updateStatus('已断开');
                console.log('WebSocket close event:', event);
                addMessage('info', `WebSocket 连接已关闭 - Code: ${event.code}, Reason: ${event.reason}, WasClean: ${event.wasClean}`);
            };
        }

        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        function sendConfig() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('请先连接 WebSocket');
                return;
            }

            const config = {
                type: 'config',
                seq: ++messageSeq,
                content: {
                    llmProvider: document.getElementById('llmProvider').value || 'qiniu',
                    asrProvider: document.getElementById('asrProvider').value || 'qiniu',
                    ttsProvider: document.getElementById('ttsProvider').value || 'qiniu',
                    voice: 'qiniu_zh_female_wwxkjx',
                    speed: 1.0,
                    role: '你是一个友好的AI助手'
                },
                timestamp: Date.now()
            };

            ws.send(JSON.stringify(config));
            addMessage('config', '发送配置: ' + JSON.stringify(config, null, 2));
        }

        function sendText() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('请先连接 WebSocket');
                return;
            }

            const text = document.getElementById('textInput').value;
            if (!text) {
                alert('请输入文本');
                return;
            }

            const message = {
                type: 'text',
                seq: ++messageSeq,
                content: {
                    content: text,
                    role: 'user'
                },
                timestamp: Date.now()
            };

            ws.send(JSON.stringify(message));
            addMessage('text', '发送文本: ' + JSON.stringify(message, null, 2));
            document.getElementById('textInput').value = '';
        }

        function sendAudio() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('请先连接 WebSocket');
                return;
            }

            // 模拟音频数据（实际应用中这里应该是真实的音频数据）
            const audioMessage = {
                type: 'audio',
                seq: ++messageSeq,
                content: 'base64_encoded_audio_data_here',
                timestamp: Date.now()
            };

            ws.send(JSON.stringify(audioMessage));
            addMessage('audio', '发送音频: ' + JSON.stringify(audioMessage, null, 2));
        }

        function updateStatus(status) {
            document.getElementById('status').textContent = status;
        }

        function addMessage(type, content) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ' + type;
            
            const timestamp = new Date().toLocaleTimeString();
            messageDiv.innerHTML = `<strong>[${timestamp}] ${type.toUpperCase()}:</strong><br><pre>${content}</pre>`;
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
    </script>
</body>
</html>